---
import ExternalLink from './ExternalLink.astro';
import { siteConfig, buildCategoryUrl } from '../config/site';

const { content, lang } = Astro.props;

const qnaSlug =
  lang === 'ko'
    ? siteConfig.discussions.categories.qnaKoSlug
    : siteConfig.discussions.categories.qnaEnSlug;
const bugSlug =
  lang === 'ko'
    ? siteConfig.discussions.categories.bugKoSlug
    : siteConfig.discussions.categories.bugEnSlug;

const qnaUrl = buildCategoryUrl(qnaSlug);
const bugUrl = buildCategoryUrl(bugSlug);
const featureUrl = buildCategoryUrl(siteConfig.discussions.categories.featureSlug);
const announcementsUrl = buildCategoryUrl(siteConfig.discussions.categories.announcementsSlug);

const hasDocs = Boolean(siteConfig.docsBaseUrl);
const hasFaq = Boolean(siteConfig.faqBaseUrl);

const macUrl = siteConfig.download.macosUrl;
const windowsUrl = siteConfig.download.windowsUrl;
const waitlist = content.waitlist;
const hasMacDownload = Boolean(macUrl);
const hasWindowsDownload = Boolean(windowsUrl);
const useSingleDownload =
  hasMacDownload && hasWindowsDownload && macUrl === windowsUrl;
const singleDownloadUrl = macUrl || windowsUrl;
const primaryDownload = hasMacDownload ? 'mac' : hasWindowsDownload ? 'windows' : null;

const languageToggle =
  lang === 'ko'
    ? { href: '/set-lang/en', label: 'English' }
    : { href: '/set-lang/ko', label: '한국어' };

const primaryDownloadClass =
  'bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-xl font-bold text-lg transition shadow-xl shadow-blue-900/30';
const secondaryDownloadClass =
  'border border-gray-700 hover:border-gray-500 text-white px-10 py-4 rounded-xl font-bold text-lg transition';

const featureIcons = [
  {
    className: 'text-blue-400',
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M4 7h10a3 3 0 0 1 3 3v7H7a3 3 0 0 1-3-3V7z"></path>
      <path d="M14 7V5a2 2 0 0 1 2-2h4v8h-3"></path>
    </svg>`
  },
  {
    className: 'text-purple-400',
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M13 3 4 14h7l-1 7 9-11h-7l1-7z"></path>
    </svg>`
  },
  {
    className: 'text-emerald-400',
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="5" y="10" width="14" height="10" rx="2"></rect>
      <path d="M8 10V7a4 4 0 0 1 8 0v3"></path>
    </svg>`
  }
];

---
<div class="relative">
  <header class="fixed top-0 z-50 w-full border-b border-gray-800 bg-[#0d1117]/80 backdrop-blur-md">
    <div class="mx-auto flex h-16 max-w-6xl items-center justify-between px-6">
      <div class="flex items-center gap-8">
        <a href="#download" class="text-2xl font-bold gradient-text">Notaly</a>
        <nav class="hidden gap-6 text-sm font-medium text-gray-400 md:flex">
          <a href="#features" class="nav-link">{content.nav.features}</a>
          <a href="#download" class="nav-link">{content.nav.download}</a>
          <a href="#community" class="nav-link">{content.nav.qna}</a>
          {hasDocs && (
            <ExternalLink href={siteConfig.docsBaseUrl} class="nav-link text-gray-400 font-medium">
              {content.nav.docs}
            </ExternalLink>
          )}
          {hasFaq && (
            <ExternalLink href={siteConfig.faqBaseUrl} class="nav-link text-gray-400 font-medium">
              {content.nav.faq}
            </ExternalLink>
          )}
        </nav>
      </div>
      <div class="flex items-center gap-4">
        <a
          href={languageToggle.href}
          class="rounded-full border border-gray-700 px-3 py-1 text-xs text-gray-400 transition hover:border-gray-500"
        >
          {languageToggle.label}
        </a>
      </div>
    </div>
    <div class="mx-auto max-w-6xl px-6 pb-4 md:hidden">
      <nav class="flex flex-wrap gap-4 text-xs font-medium text-gray-400">
        <a href="#features" class="nav-link">{content.nav.features}</a>
        <a href="#download" class="nav-link">{content.nav.download}</a>
        <a href="#community" class="nav-link">{content.nav.qna}</a>
        {hasDocs && (
          <ExternalLink href={siteConfig.docsBaseUrl} class="nav-link text-gray-400 font-medium">
            {content.nav.docs}
          </ExternalLink>
        )}
        {hasFaq && (
          <ExternalLink href={siteConfig.faqBaseUrl} class="nav-link text-gray-400 font-medium">
            {content.nav.faq}
          </ExternalLink>
        )}
      </nav>
    </div>
  </header>

  <main class="pt-16">
    <section id="download" class="mx-auto max-w-6xl scroll-mt-24 px-6 pt-24 text-center md:pt-32">
      <div class="mb-8 inline-block rounded-full border border-blue-500/30 bg-blue-900/20 px-4 py-1 text-xs font-bold text-blue-400">
        {content.hero.badge}
      </div>

      <h1 class="hero-title mb-8 text-6xl font-bold gradient-text md:text-8xl">
        {content.hero.title}
      </h1>
      <p class="mb-10 text-2xl font-light leading-tight text-gray-300 md:text-4xl">
        <span>{content.hero.taglineLine1}</span>
        <br class="md:hidden" />
        <span> {content.hero.taglineLine2}</span>
      </p>
      <p class="mx-auto mb-12 max-w-2xl text-lg leading-relaxed text-gray-500 md:text-xl">
        {content.hero.description}
      </p>
      <div class="flex flex-wrap justify-center gap-4">
        {useSingleDownload && singleDownloadUrl && (
          <ExternalLink href={singleDownloadUrl} variant="button" class={primaryDownloadClass}>
            {content.hero.ctaDownload}
          </ExternalLink>
        )}
        {!useSingleDownload && hasMacDownload && (
          <ExternalLink
            href={macUrl}
            variant="button"
            class={primaryDownload === 'mac' ? primaryDownloadClass : secondaryDownloadClass}
          >
            {content.hero.ctaMac}
          </ExternalLink>
        )}
        <button
          type="button"
          class={`${primaryDownload === 'windows' ? primaryDownloadClass : secondaryDownloadClass} waitlist-button inline-flex items-center gap-2`}
          data-waitlist-open
        >
          <span class="waitlist-label">{content.hero.ctaWindows}</span>
        </button>
      </div>
      <div
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 px-4 py-10"
        data-waitlist-modal
        data-waitlist-success={waitlist.success}
        data-waitlist-exists={waitlist.exists}
        data-waitlist-error={waitlist.error}
        data-waitlist-invalid={waitlist.invalid}
        data-waitlist-locale={lang}
        data-waitlist-source="windows"
        role="dialog"
        aria-modal="true"
        aria-labelledby="waitlist-title"
        aria-describedby="waitlist-copy"
      >
        <div class="card w-full max-w-lg rounded-3xl p-8 text-left shadow-2xl">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 id="waitlist-title" class="text-2xl font-bold text-gray-100">
                {waitlist.title}
              </h3>
              <p id="waitlist-copy" class="mt-2 text-sm text-gray-400">
                {waitlist.copy}
              </p>
            </div>
            <button
              type="button"
              class="rounded-full border border-gray-700 px-3 py-1 text-xs text-gray-400 transition hover:border-gray-500"
              data-waitlist-close
            >
              {waitlist.close}
            </button>
          </div>
          <form class="mt-6 space-y-4" data-waitlist-form>
            <label class="sr-only" for="waitlist-email">Email</label>
            <input
              id="waitlist-email"
              name="email"
              type="email"
              required
              placeholder={waitlist.placeholder}
              autocomplete="email"
              class="w-full rounded-xl border border-gray-800 bg-black/50 px-4 py-3 text-sm text-gray-100 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
              data-waitlist-email
            />
            <button
              type="submit"
              class="w-full rounded-xl bg-blue-600 px-4 py-3 text-sm font-bold text-white transition hover:bg-blue-500"
              data-waitlist-submit
            >
              {waitlist.submit}
            </button>
            <p class="hidden text-sm" data-waitlist-message aria-live="polite"></p>
          </form>
        </div>
      </div>
    </section>

    <section class="mx-auto max-w-5xl px-6 py-12">
      <div class="card grid items-center gap-10 rounded-[2.5rem] p-10 md:grid-cols-2">
        <div class="text-left">
          <h3 class="code-font mb-4 text-sm font-bold text-blue-400 opacity-70">
            {content.scatter.left.title}
          </h3>
          <div class="code-font rounded-2xl border border-gray-800 bg-black p-6 text-xs leading-relaxed text-gray-400 shadow-inner md:text-sm">
            <span class="text-green-500">## Notaly Notes</span><br />
            - Review API <span class="text-purple-400">&#123;type: 'task'&#125;</span><br />
            <br />
            <span class="text-green-500">## Diary</span><br />
            - Buy coffee <span class="text-purple-400">&#123;type: 'task'&#125;</span>
          </div>
        </div>
        <div class="text-left">
          <h3 class="code-font mb-4 text-sm font-bold text-purple-400 opacity-70">
            {content.scatter.right.title}
          </h3>
          <div class="code-font rounded-2xl border border-gray-800 bg-[#0a0c10] p-6 text-xs leading-relaxed text-gray-300 shadow-inner md:text-sm">
            <span class="text-blue-400">query</span> &#123;type: 'task'&#125;<br />
            <hr class="my-3 border-gray-800" />
            <div class="space-y-2">
              ● Review API<br />
              ● Buy coffee
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="features" class="mx-auto max-w-6xl scroll-mt-24 px-6 py-32">
      <h2 class="mb-16 text-center text-3xl font-bold text-gray-200">
        {content.features.title}
      </h2>
      <div class="grid gap-8 md:grid-cols-3">
        {content.features.cards.map((card, index) => (
          <div class="card rounded-3xl p-10">
            <div
              class={`mb-6 inline-flex h-12 w-12 items-center justify-center rounded-2xl border border-gray-800 bg-[#0f141c] ${featureIcons[index % featureIcons.length].className}`}
            >
              <span class="h-6 w-6" set:html={featureIcons[index % featureIcons.length].svg} />
            </div>
            <h4 class="mb-4 text-xl font-bold">{card.title}</h4>
            <p class="leading-relaxed text-gray-500">{card.copy}</p>
          </div>
        ))}
      </div>
    </section>

    <section class="mx-auto max-w-5xl px-6 py-16">
      <div class="card rounded-3xl p-10">
        <h2 class="mb-4 text-2xl font-bold text-gray-200">{content.beta.title}</h2>
        <p class="leading-relaxed text-gray-500">{content.beta.copy}</p>
        <div class="mt-4 space-y-2 text-sm text-gray-400">
          <p>{content.beta.os}</p>
          <p>{content.beta.updates}</p>
        </div>
      </div>
    </section>

    {hasFaq && (
      <section id="faq" class="mx-auto max-w-5xl scroll-mt-24 px-6 py-16">
        <div class="card flex flex-col items-start justify-between gap-6 rounded-3xl p-8 md:flex-row md:items-center">
          <div>
            <h2 class="text-2xl font-bold text-gray-200">{content.faq.title}</h2>
            <p class="mt-2 text-gray-500">{content.faq.copy}</p>
          </div>
          <ExternalLink
            href={siteConfig.faqBaseUrl}
            variant="button"
            class="border border-gray-700 px-8 py-3 text-sm font-bold text-gray-200 transition hover:border-gray-500"
          >
            {content.faq.cta}
          </ExternalLink>
        </div>
      </section>
    )}

    <section id="community" class="mx-auto max-w-5xl scroll-mt-24 px-6 py-24 text-center">
      <h2 class="mb-6 text-4xl font-bold text-gray-200">{content.community.title}</h2>
      <p class="mx-auto mb-12 max-w-2xl text-lg text-gray-500">
        {content.community.copy}
      </p>

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {qnaUrl && (
          <ExternalLink
            href={qnaUrl}
            class="card flex flex-col items-center justify-center rounded-2xl p-6 hover:bg-gray-800/50"
          >
            <span class="mb-3 inline-flex h-10 w-10 items-center justify-center rounded-2xl border border-gray-800 bg-[#0f141c] text-blue-400">
              <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M21 11.5a8.5 8.5 0 0 1-8.5 8.5 9 9 0 0 1-4.7-1.3L3 20l1.3-4.7A8.5 8.5 0 0 1 21 11.5z"></path>
                <path d="M9.5 11.5h5"></path>
                <path d="M9.5 14h3"></path>
              </svg>
            </span>
            <span class="font-bold">{content.community.qna}</span>
          </ExternalLink>
        )}
        {bugUrl && (
          <ExternalLink
            href={bugUrl}
            class="card flex flex-col items-center justify-center rounded-2xl p-6 hover:bg-gray-800/50"
          >
            <span class="mb-3 inline-flex h-10 w-10 items-center justify-center rounded-2xl border border-gray-800 bg-[#0f141c] text-rose-400">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M8 10V6a4 4 0 0 1 8 0v4"></path>
                <rect x="6" y="10" width="12" height="10" rx="4"></rect>
                <path d="M4 13h2"></path>
                <path d="M18 13h2"></path>
                <path d="M5 9l2 2"></path>
                <path d="M19 9l-2 2"></path>
              </svg>
            </span>
            <span class="font-bold">{content.community.bug}</span>
          </ExternalLink>
        )}
        {featureUrl && (
          <ExternalLink
            href={featureUrl}
            class="card flex flex-col items-center justify-center rounded-2xl p-6 hover:bg-gray-800/50"
          >
            <span class="mb-3 inline-flex h-10 w-10 items-center justify-center rounded-2xl border border-gray-800 bg-[#0f141c] text-purple-400">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M9 18h6"></path>
                <path d="M10 22h4"></path>
                <path d="M8 14a5 5 0 1 1 8 0c0 1.5-.7 2.5-1.7 3.3-.6.5-1.3 1-1.3 1.7H11c0-.7-.7-1.2-1.3-1.7C8.7 16.5 8 15.5 8 14z"></path>
                <path d="M12 2v2"></path>
                <path d="M4.5 6.5 6 8"></path>
                <path d="M19.5 6.5 18 8"></path>
                <path d="M3 12h2"></path>
                <path d="M19 12h2"></path>
              </svg>
            </span>
            <span class="text-sm font-bold">{content.community.feature}</span>
          </ExternalLink>
        )}
        {announcementsUrl && (
          <ExternalLink
            href={announcementsUrl}
            class="card flex flex-col items-center justify-center rounded-2xl p-6 hover:bg-gray-800/50"
          >
            <span class="mb-3 inline-flex h-10 w-10 items-center justify-center rounded-2xl border border-gray-800 bg-[#0f141c] text-emerald-400">
              <svg class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M4 12V7a1 1 0 0 1 1-1h6l6-2v12l-6-2H5a1 1 0 0 1-1-1z"></path>
                <path d="M18 9v6"></path>
              </svg>
            </span>
            <span class="font-bold">{content.community.announcements}</span>
          </ExternalLink>
        )}
      </div>
    </section>
  </main>

  <footer class="mt-16 border-t border-gray-900 py-10 text-center text-gray-600">
    <p class="code-font mb-4 text-sm">{content.footer.tagline}</p>
    <p>© {new Date().getFullYear()} Notaly Team. All rights reserved.</p>
  </footer>
</div>

<script>
  const modal = document.querySelector('[data-waitlist-modal]');
  if (modal) {
    const openButton = document.querySelector('[data-waitlist-open]');
    const closeButton = modal.querySelector('[data-waitlist-close]');
    const form = modal.querySelector('[data-waitlist-form]');
    const emailInput = modal.querySelector('[data-waitlist-email]');
    const message = modal.querySelector('[data-waitlist-message]');
    const submitButton = modal.querySelector('[data-waitlist-submit]');
    const texts = {
      success: modal.dataset.waitlistSuccess || 'Saved.',
      exists: modal.dataset.waitlistExists || 'Already saved.',
      error: modal.dataset.waitlistError || 'Please try again.',
      invalid: modal.dataset.waitlistInvalid || 'Invalid email.'
    };
    const locale = modal.dataset.waitlistLocale || 'en';
    const source = modal.dataset.waitlistSource || 'windows';

    const showMessage = (text, tone) => {
      if (!message) return;
      message.textContent = text;
      message.classList.remove('hidden', 'text-rose-400', 'text-emerald-400', 'text-blue-400');
      if (tone === 'success') {
        message.classList.add('text-emerald-400');
      } else if (tone === 'info') {
        message.classList.add('text-blue-400');
      } else {
        message.classList.add('text-rose-400');
      }
    };

    const openModal = () => {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
      if (message) {
        message.classList.add('hidden');
        message.textContent = '';
      }
      if (emailInput instanceof HTMLInputElement) {
        emailInput.focus();
      }
    };

    const closeModal = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
      if (form instanceof HTMLFormElement) {
        form.reset();
      }
      if (message) {
        message.classList.add('hidden');
        message.textContent = '';
      }
    };

    openButton?.addEventListener('click', openModal);
    closeButton?.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    form?.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!(emailInput instanceof HTMLInputElement) || !(form instanceof HTMLFormElement)) {
        return;
      }
      const email = emailInput.value.trim();
      if (!email || !emailInput.checkValidity()) {
        showMessage(texts.invalid, 'error');
        return;
      }

      submitButton?.setAttribute('disabled', 'true');
      try {
        const response = await fetch('/api/waitlist', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ email, source, locale })
        });
        const data = await response.json().catch(() => null);
        if (!response.ok) {
          showMessage(texts.error, 'error');
          return;
        }

        const status = data?.status;
        if (status === 'exists') {
          showMessage(texts.exists, 'info');
        } else {
          showMessage(texts.success, 'success');
        }
      } catch {
        showMessage(texts.error, 'error');
      } finally {
        submitButton?.removeAttribute('disabled');
      }
    });
  }
</script>
